<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <title>Strava Activity Histogram</title>

    <!-- Chart.js 2.x (matches your original Postman visualizer config) -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/2.5.0/Chart.min.js"></script>

    <style>
      html,
      body {
        margin: 0;
        padding: 0;
        height: 100%;
        width: 100%;
        background: #111018;
        color: #f5f5f5;
        font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI",
          sans-serif;
      }

      .wrapper {
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        height: 100%;
        padding: 24px;
        box-sizing: border-box;
      }

      h1 {
        margin-bottom: 6px;
        font-size: 24px;
        font-weight: 600;
      }

      .subtitle {
        margin-bottom: 16px;
        font-size: 12px;
        color: #cccccc;
      }

      #workoutChart {
        max-width: 1200px;
        width: 100%;
        max-height: 480px;
        background: #1b1922;
        padding: 16px;
        border-radius: 8px;
      }

      .error {
        color: #ffb3b3;
        margin-top: 12px;
        font-size: 14px;
      }
    </style>
  </head>
  <body>
    <div class="wrapper">
      <h1>Strava Activity Histogram</h1>
      <div class="subtitle">
        Workout Activities: Elapsed Time by Date (from <code>data.json</code>)
      </div>
      <canvas id="workoutChart" height="120"></canvas>
      <div id="error" class="error"></div>
    </div>

    <script>
      async function init() {
        const errorEl = document.getElementById("error");

        try {
          // 1️⃣ Fetch the full dataset from your repo root
          const res = await fetch("data.json?version=2");

          if (!res.ok) {
            throw new Error("Failed to load data.json (" + res.status + ")");
          }

          const response = await res.json(); // array of Strava activities

          // 2️⃣ Sort by date ascending
          const sorted = response
            .slice()
            .sort(
              (a, b) => new Date(a.start_date) - new Date(b.start_date)
            );

          // 3️⃣ Build labels + elapsed_time (seconds → minutes, 1 decimal)
          const labels = sorted.map(item => {
            const d = new Date(item.start_date);
            return d.toISOString().slice(0, 10); // YYYY-MM-DD
          });

          const dataMinutes = sorted.map(item =>
            item.elapsed_time
              ? Math.round((item.elapsed_time / 60) * 10) / 10
              : 0
          );

          // 4️⃣ Render Chart.js bar chart
          const ctx = document.getElementById("workoutChart");

          new Chart(ctx, {
            type: "bar",
            data: {
              labels,
              datasets: [
                {
                  label: "Elapsed Time (minutes)",
                  data: dataMinutes,
                  backgroundColor: "rgba(54, 162, 235, 0.4)",
                  borderColor: "rgba(54, 162, 235, 1)",
                  borderWidth: 1
                }
              ]
            },
            options: {
              responsive: true,
              legend: { display: true },
              title: {
                display: false
              },
              scales: {
                xAxes: [
                  {
                    display: true,
                    scaleLabel: {
                      display: true,
                      labelString: "Date"
                    },
                    ticks: {
                      autoSkip: true,
                      maxTicksLimit: 15
                    }
                  }
                ],
                yAxes: [
                  {
                    display: true,
                    scaleLabel: {
                      display: true,
                      labelString: "Elapsed Time (minutes)"
                    },
                    ticks: {
                      beginAtZero: true
                    }
                  }
                ]
              },
              tooltips: {
                callbacks: {
                  label: function(tooltipItem, data) {
                    const v = data.datasets[0].data[tooltipItem.index];
                    return v + " min";
                  }
                }
              }
            }
          });
        } catch (e) {
          console.error(e);
          if (errorEl) {
            errorEl.textContent =
              "Error loading visualization: " + e.message;
          }
        }
      }

      window.addEventListener("DOMContentLoaded", init);
    </script>
  </body>
</html>
